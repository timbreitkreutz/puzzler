<!DOCTYPE html>
<html lang="en">
<title>
  Puzzler
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <style type="text/css">
    canvas { border: 1px solid black; }
  </style>
</title>
<body>
  <canvas width="500" height="500" id="puzzle">
    <p>
      Please try a newer browser!  Thanks.
    </p>
  </canvas>
  <script type="text/javascript">
    (function () {
      "use strict";

      var buildPuzzle, shuffle, swap, pictureUrl, emptyTile, tiles;

      swap = function(aa, bb) {
        var row, col;
        row = aa.row;
        col = aa.col;
        aa.row = bb.row;
        aa.col = bb.col;
        bb.row = row;
        bb.col = col; 
      };

      shuffle = function () {
        var ii, neighbours;
    
        //for (ii = 0; ii < tiles.length * 1; ii += 1) {
        for (ii = 0; ii < 3; ii += 1) {
          neighbours = emptyTile.neighbours();

          swap(emptyTile, neighbours[Math.floor(Math.random() * neighbours.length)]);
        }
      };

      buildPuzzle = function (count, size, border, imageUrl) {
        var canvas, ctx, img, tile, move, puzzleSolved, imageSize;
      
        canvas = document.getElementById('puzzle');
        tile = {
          draw: function () {
            if (this.empty) {
              ctx.fillStyle = "rgb(255, 255, 255)";
              ctx.fillRect(this.col * (size + border), 
                     this.row * (size + border),
                     size, size);
            } else {
              ctx.drawImage(img, this.imageCol * imageSize, 
                          this.imageRow * imageSize,
                          imageSize, imageSize, 
                          this.col * (size + border),
                          this.row * (size + border), 
                          size, size);
            }
          },
          contains: function (xx, yy) {
            if (this.empty) {
              return false;
            }
            return this.col * (size + border) < xx && 
                  (this.col + 1) * (size + border) > xx &&
                  this.row * (size + border) < yy && 
                  (this.row + 1) * (size + border) > yy;
          },
          neighbour: function (tile) {
            return Math.abs(this.col - tile.col) + Math.abs(this.row - tile.row) === 1;
          },
          emptyNeighbour: function () {
            return this.neighbour(emptyTile);
          },
          neighbours: function () {
            var that, result = [];
            that = this;
            tiles.forEach(function (tile) {
              if (that.neighbour(tile)) {
                result.push(tile);
              }
            });
            return result;
          },
          solved: function () {
            return this.col === this.imageCol && this.row === this.imageRow;
          }
        };
        if (canvas.getContext) {
          ctx = canvas.getContext('2d');

          img = new Image();
          img.src = imageUrl;
          
          tiles = []; 
          img.onload = function () {
            var ii, jj;
            if (img.height > img.width) {
              imageSize = img.width / count;
            } else {
              imageSize = img.height / count;
            }
            for (ii = 0; ii < count; ii += 1) {
              for (jj = 0; jj < count; jj += 1) {
                tile = Object.create(tile);
                tile.row = ii;
                tile.col = jj;
                tile.imageRow = ii;
                tile.imageCol = jj;
                tile.empty = (ii === 0 && jj === count - 1);
                tiles.push(tile);
                if (tile.empty) {
                  emptyTile = tile;
                }
              }
            }
            while (puzzleSolved()) {
              shuffle();
            }
            tiles.forEach(function (tile) {
              tile.draw();
            });
          };
        }
        move = function (tile, emptyTile) {
          swap(tile, emptyTile);
          tile.draw();
          emptyTile.draw();
        };
        puzzleSolved = function () {
          var solved = true;
          tiles.forEach(function (tile) {
            if (!tile.solved()) { 
              solved = false;
            }
          });
          return solved;
        };
        canvas.onclick = function(ev) {
          if (puzzleSolved()) {
            return;
          }
          tiles.forEach(function (tile) {
            if (tile.contains(ev.x, ev.y) && tile.emptyNeighbour()) {
              move(tile, emptyTile);
              if (puzzleSolved()) {
                emptyTile.empty = false;
                emptyTile.draw();
              }
            }
          });
        };
      };
      //pictureUrl = "http://www.teenvogue.com/images/fashion/spring-trends/2013-05/karlie-kloss-frame-denim-intro.jpg"
      pictureUrl = "http://ia.media-imdb.com/images/M/MV5BNDM1NzkzMjQ4NF5BMl5BanBnXkFtZTcwMDE3Nzk3Mg@@._V1_SX640_SY720_.jpg";
      pictureUrl = "http://www.tumblr18.com/t18/2013/10/Puppies-in-a-basket.jpeg";
      //pictureUrl = "http://thechive.files.wordpress.com/2011/03/facebook-bikini-13.jpg";

      window.onload = function() { 
        buildPuzzle(3, 150, 2, pictureUrl); 
      };
    }());
  </script>
</body>
</html>
